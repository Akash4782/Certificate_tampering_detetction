<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Certificate Tampering Detection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="dashboard-page">
    {% include 'components/header.html' %}

    <div class="main-layout">
        {% include 'components/sidebar.html' %}

        <main class="main-content">
            <div class="page-header">
                <h1>Admin Dashboard</h1>
                <p>Overview of certificates and blockchain status</p>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">
                    <span>{{ message }}</span>
                    <button class="flash-close" onclick="this.parentElement.remove()">Ã—</button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ðŸ“œ</div>
                    <div class="stat-content">
                        <h3>{{ total_certificates }}</h3>
                        <p>Total Certificates</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">ðŸ‘¥</div>
                    <div class="stat-content">
                        <h3>{{ total_students }}</h3>
                        <p>Total Students</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">ðŸ”—</div>
                    <div class="stat-content">
                        <h3>{{ chain_info.certificate_blocks }}</h3>
                        <p>Blockchain Blocks</p>
                    </div>
                </div>

                <div class="stat-card {% if chain_info.is_valid %}stat-success{% else %}stat-danger{% endif %}">
                    <div class="stat-icon">âœ“</div>
                    <div class="stat-content">
                        <h3>{% if chain_info.is_valid %}Valid{% else %}Invalid{% endif %}</h3>
                        <p>Blockchain Status</p>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-card">
                    <h3>Certificates Issued by Month</h3>
                    <canvas id="certificatesChart"></canvas>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="content-grid">
                <div class="content-card">
                    <h3>Recent Certificates</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Course</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cert in recent_certificates %}
                                <tr>
                                    <td>{{ cert.student_name }}</td>
                                    <td>{{ cert.course_name }}</td>
                                    <td>{{ cert.issue_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <a href="{{ url_for('download_certificate', cert_id=cert.id) }}"
                                            class="btn btn-sm btn-primary">Download</a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">No certificates yet</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="content-card">
                    <h3>Recent Verifications</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Hash</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in recent_verifications %}
                                <tr>
                                    <td class="hash-cell">{{ log.blockchain_hash[:16] }}...</td>
                                    <td>
                                        <span
                                            class="badge badge-{% if log.status == 'Valid' %}success{% else %}danger{% endif %}">
                                            {{ log.status }}
                                        </span>
                                    </td>
                                    <td>{{ log.verified_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center">No verifications yet</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    {% include 'components/footer.html' %}

    <script>
        // Global Chart Defaults for Dark Theme
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.08)';

        // Certificates Chart
        const labels = {{ chart_labels | safe }};
        const data = {{ chart_data | safe }};
        const ctx = document.getElementById('certificatesChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Certificates Issued',
                    data: data,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#0f172a',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleColor: '#f8fafc',
                        bodyColor: '#94a3b8',
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            borderDash: [4, 4]
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    </script>
</body>

</html>